---
phase: 05-scope-all-routes-and-full-isolation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/clients/overview/route.ts
  - src/app/api/dashboard/metrics/route.ts
  - src/app/api/search/route.ts
  - src/app/api/team/route.ts
  - src/app/api/team/[id]/route.ts
  - src/app/api/team/invite/route.ts
  - src/app/api/team/accept-invite/route.ts
  - supabase/migrations/20260227000000_deprecate_user_dso_access.sql
autonomous: true

must_haves:
  truths:
    - "Enumeration routes (clients/overview, dashboard/metrics, search) filter DSO lists by org"
    - "GET /api/team queries org_members instead of user_dso_access for team listing"
    - "Team routes (PATCH/DELETE team/[id], invite, accept-invite) verify org membership"
    - "user_dso_access deprecation is documented in a migration file with cleanup steps"
    - "A user in Org A cannot see DSO data from Org B in any enumeration endpoint"
  artifacts:
    - path: "src/app/api/clients/overview/route.ts"
      provides: "Org-filtered client overview"
      contains: "getUserOrg"
    - path: "src/app/api/search/route.ts"
      provides: "Org-filtered search results"
      contains: "getUserOrg"
    - path: "src/app/api/team/route.ts"
      provides: "Org-based team member listing"
      contains: "org_members"
    - path: "supabase/migrations/20260227000000_deprecate_user_dso_access.sql"
      provides: "Deprecation flag and cleanup migration documentation"
      contains: "DEPRECATED"
  key_links:
    - from: "src/app/api/clients/overview/route.ts"
      to: "src/lib/auth.ts"
      via: "import getUserOrg"
      pattern: "import.*getUserOrg.*from.*auth"
    - from: "src/app/api/team/route.ts"
      to: "org_members table"
      via: "supabaseAdmin query replacing user_dso_access"
      pattern: "from.*org_members"
---

<objective>
Migrate all Category B (enumeration) routes to filter by org, add org membership checks to legacy team routes, and document the user_dso_access deprecation.

Purpose: After this plan, no enumeration endpoint can leak DSOs from other orgs. The team route migrates from the legacy user_dso_access-based listing to org_members. Combined with Plan 02, this achieves full route isolation (SC-5). The deprecation migration documents the cleanup path for user_dso_access (SC-6).

Output: 7 route files updated; 1 deprecation migration file created.
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-scope-all-routes-and-full-isolation/05-RESEARCH.md
@.planning/phases/05-scope-all-routes-and-full-isolation/05-01-SUMMARY.md
@src/lib/auth.ts
@src/app/api/clients/overview/route.ts
@src/app/api/dashboard/metrics/route.ts
@src/app/api/search/route.ts
@src/app/api/team/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Category B enumeration routes and team routes to org-filtered queries</name>
  <files>
    src/app/api/clients/overview/route.ts
    src/app/api/dashboard/metrics/route.ts
    src/app/api/search/route.ts
    src/app/api/team/route.ts
    src/app/api/team/[id]/route.ts
    src/app/api/team/invite/route.ts
    src/app/api/team/accept-invite/route.ts
  </files>
  <action>
**Category B routes — add org filter to DSO enumeration queries:**

For `clients/overview`, `dashboard/metrics`, and `search` routes, the pattern is:
1. After identifying `userId` (existing auth already works), call `getUserOrg(userId)` to get `orgId`.
2. If no org, return the appropriate empty response (same as current empty-access behavior).
3. Replace the existing `user_dso_access` query with an org-filtered version:
   ```typescript
   const { data: accessRecords } = await supabaseAdmin
       .from('user_dso_access')
       .select('dso_id, dsos!inner(org_id)')
       .eq('user_id', userId)
       .eq('dsos.org_id', orgInfo.orgId);
   const accessibleDsoIds = accessRecords?.map(r => r.dso_id) || [];
   ```
4. The rest of the route logic stays the same — it already uses `accessibleDsoIds` to filter.

**Route-by-route:**

1. **`GET /api/clients/overview`** — After the `requireAuth`/fallback block (line ~8-22) that resolves `userId`:
   - Add: `const orgInfo = await getUserOrg(userId); if (!orgInfo) return NextResponse.json({ clients: [] });`
   - Replace the `user_dso_access` query (line ~25-28) with the org-filtered version above.
   - Import `getUserOrg` from `@/lib/auth`.

2. **`GET /api/dashboard/metrics`** — After `requireAuthWithFallback` resolves `userId`:
   - Add: `const orgInfo = await getUserOrg(userId); if (!orgInfo) return NextResponse.json(emptyMetrics);` (use the existing `emptyMetrics` object that's already defined in this file).
   - Replace the `user_dso_access` query (line ~31-34) with the org-filtered version.
   - For the `dsoId`-specific path (line ~19-28), replace `checkDsoAccess(userId, dsoId)` with `requireOrgDsoAccess(request, dsoId)`. This ensures org check even when a specific DSO is requested.
   - Import `getUserOrg` and `requireOrgDsoAccess` from `@/lib/auth`. Remove `checkDsoAccess` import.

3. **`GET /api/search`** — After `requireAuthWithFallback` resolves `userId`:
   - Add: `const orgInfo = await getUserOrg(userId); if (!orgInfo) return NextResponse.json({ results: [] });`
   - Replace the `user_dso_access` query (line ~31-34) with the org-filtered version.
   - Import `getUserOrg` from `@/lib/auth`.

**Team routes — migrate GET to org_members, add org checks to others:**

4. **`GET /api/team`** — This is the biggest change. Currently queries `user_dso_access` to find team members. Rewrite to query `org_members` instead:
   - After resolving `userId` (existing auth + fallback):
   - Get user's org: `const orgInfo = await getUserOrg(userId); if (!orgInfo) return NextResponse.json({ members: [] });`
   - Query org members: `const { data: orgMembers } = await supabaseAdmin.from('org_members').select('*, user_profiles(*)').eq('org_id', orgInfo.orgId).order('joined_at', { ascending: true });`
   - Transform to the existing `TeamMember` interface shape. For each member:
     - `id`: member row id
     - `user_id`: member.user_id
     - `email`: member.user_profiles?.email or fall back to auth admin API (existing pattern)
     - `name`: member.user_profiles?.display_name or derive from email (existing pattern)
     - `role`: member.role (this is now the ORG role — owner/admin/member — not the DSO role)
     - `created_at`: member.joined_at
     - `is_current_user`: member.user_id === userId
   - Remove the `user_dso_access` queries entirely.
   - Keep the `primaryDsoId` in response for backward compatibility — get it from the user's first `user_dso_access` row (still needed for invite flow).
   - Import `getUserOrg` from `@/lib/auth`.

5. **`PATCH /api/team/[id]`** and **`DELETE /api/team/[id]`** — These modify `user_dso_access` roles/rows (DSO-level, not org-level). Add an org membership check BEFORE the existing DSO access check:
   - After resolving `userId`, call `getUserOrg(userId)`. If no org, return 403.
   - Keep the existing `checkDsoAccess` logic — this is still the DSO-level role change.
   - Import `getUserOrg` from `@/lib/auth`.

6. **`POST /api/team/invite`**, **`GET /api/team/invite`**, **`DELETE /api/team/invite`** — Add org membership check:
   - After resolving `userId`, call `getUserOrg(userId)`. If no org, return 403.
   - Keep existing DSO access checks for the invite's target DSO.
   - Import `getUserOrg` from `@/lib/auth`.

7. **`POST /api/team/accept-invite`** — Uses `requireAuth` with body fallback. Add org membership check:
   - After resolving `userId`, the route processes invites from `team_invites`. This operates on the old DSO-level invite system.
   - Add `getUserOrg(userId)` check. If no org, return 403 — a user must be in an org to accept team invites.
   - Import `getUserOrg` from `@/lib/auth`.

CRITICAL: The `GET /api/team` rewrite changes the data source from `user_dso_access` to `org_members`. The frontend `team-members.tsx` component consumes this response. The response shape (`{ members: TeamMember[], dso_id }`) must stay identical. The `role` field will now be the org role (owner/admin/member) instead of the DSO role (admin/manager/viewer). This is the intended behavior — the org role is now the authoritative role for team member display.
  </action>
  <verify>Run `npx tsc --noEmit` — zero type errors. Run `npm run build` — build succeeds. Grep for `getUserOrg\|requireOrgDsoAccess` in all modified files to confirm org checks are present. Grep `user_dso_access` in `team/route.ts` GET handler to confirm it's removed from the main team listing query (it may remain for the `primaryDsoId` backward-compat lookup).</verify>
  <done>All Category B routes filter by org. GET /api/team uses org_members. All team sub-routes verify org membership. No enumeration endpoint can return cross-org DSO data.</done>
</task>

<task type="auto">
  <name>Task 2: Create user_dso_access deprecation migration and document cleanup path</name>
  <files>supabase/migrations/20260227000000_deprecate_user_dso_access.sql</files>
  <action>
Create a new migration file that:

1. Adds a SQL comment block documenting the deprecation of `user_dso_access`:
```sql
-- ============================================================
-- DEPRECATION: user_dso_access table
-- ============================================================
-- As of Phase 5 (2026-02-27), org_members is the primary access control gate.
-- user_dso_access remains active as the per-DSO assignment filter (ISO-02):
--   - org_members gates the org boundary (who is in the org)
--   - user_dso_access gates per-DSO visibility (which DSOs within the org)
--
-- This table is NOT removed in this migration. It is flagged as deprecated
-- for a future cleanup milestone.
--
-- CLEANUP MIGRATION (future milestone):
-- Step 1: Verify all routes use requireOrgDsoAccess (org check + DSO check)
-- Step 2: Confirm no route relies solely on user_dso_access for auth
-- Step 3: Evaluate whether user_dso_access can be merged into a simpler
--         org_dso_assignments table (same data, clearer name)
-- Step 4: Remove legacy checkDsoAccess / requireDsoAccessWithFallback from lib/auth.ts
-- Step 5: Remove requireDsoAccess from lib/auth.ts
-- Step 6: Rename or restructure user_dso_access if keeping per-DSO assignments
-- Step 7: Update team_invites to use org_invites if team_invites is no longer needed
-- ============================================================
```

2. Adds a comment to the `user_dso_access` table itself:
```sql
COMMENT ON TABLE user_dso_access IS 'DEPRECATED (Phase 5, 2026-02-27): Per-DSO assignment filter. Primary access control is now org_members. See cleanup steps above.';
```

3. Adds a comment to the `team_invites` table:
```sql
COMMENT ON TABLE team_invites IS 'LEGACY (Phase 5, 2026-02-27): DSO-scoped invite system. Superseded by org_invites for org-level invitations. Kept for backward compatibility with existing team routes.';
```

This migration is documentation-only — it changes NO data and NO schema. It adds table comments that are visible in Supabase Studio and `\dt+` in psql.

Do NOT create this as a Supabase CLI migration (no `supabase migration new`). Simply create the file directly in the migrations directory with the correct timestamp-based filename.
  </action>
  <verify>The migration file exists at the expected path. It contains only COMMENT ON TABLE statements and SQL comments — no ALTER TABLE, no DROP, no data changes. Run `cat` on the file to confirm it's safe.</verify>
  <done>Deprecation migration documents the cleanup path for user_dso_access and team_invites. Table comments are set for visibility in database tools. No schema or data changes.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. `clients/overview`, `dashboard/metrics`, and `search` all import and use `getUserOrg`
4. `GET /api/team` queries `org_members` instead of `user_dso_access` for team listing
5. All team sub-routes (`team/[id]`, `team/invite`, `team/accept-invite`) verify org membership
6. Deprecation migration file exists and contains only COMMENT statements
7. No route can enumerate DSOs from outside the user's org
</verification>

<success_criteria>
- All enumeration routes are org-filtered — cross-org data leaks are closed
- GET /api/team uses org_members as the source of truth for team listing
- Legacy team routes have org membership gates
- user_dso_access deprecation is formally documented in a migration
- SC-6 is satisfied (deprecation flag set, cleanup migration documented)
</success_criteria>

<output>
After completion, create `.planning/phases/05-scope-all-routes-and-full-isolation/05-03-SUMMARY.md`
</output>
