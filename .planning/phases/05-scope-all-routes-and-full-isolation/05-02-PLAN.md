---
phase: 05-scope-all-routes-and-full-isolation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/doctors/route.ts
  - src/app/api/doctors/[id]/route.ts
  - src/app/api/doctors/[id]/periods/route.ts
  - src/app/api/activities/route.ts
  - src/app/api/tasks/route.ts
  - src/app/api/progress/route.ts
  - src/app/api/dsos/route.ts
  - src/app/api/data-tables/route.ts
  - src/app/api/data-tables/[id]/route.ts
  - src/app/api/data-tables/[id]/columns/route.ts
  - src/app/api/data-tables/[id]/columns/[columnId]/route.ts
  - src/app/api/data-tables/[id]/rows/route.ts
  - src/app/api/data-tables/[id]/rows/[rowId]/route.ts
  - src/app/api/data-tables/[id]/rows/[rowId]/periods/route.ts
  - src/app/api/data-tables/[id]/rows/[rowId]/periods/[periodId]/route.ts
  - src/app/api/data-tables/[id]/periods/batch/route.ts
  - src/app/api/data-tables/format-phones/route.ts
autonomous: true

must_haves:
  truths:
    - "Every DSO-scoped route verifies org membership via requireOrgDsoAccess before returning data"
    - "A user not in the org gets 403 even if they have a user_dso_access row for a DSO in that org"
    - "A user in the org but without user_dso_access for a specific DSO gets 403 for that DSO's data"
    - "The user_id body fallback pattern is preserved on all routes that already had it"
    - "GET /api/dsos and PATCH /api/dsos also filter by org membership"
  artifacts:
    - path: "src/app/api/doctors/route.ts"
      provides: "Org-gated doctor listing and creation"
      contains: "requireOrgDsoAccess"
    - path: "src/app/api/data-tables/route.ts"
      provides: "Org-gated data table listing and creation"
      contains: "requireOrgDsoAccess"
    - path: "src/app/api/dsos/route.ts"
      provides: "Org-filtered DSO listing, org-gated DSO update"
      contains: "getUserOrg"
  key_links:
    - from: "src/app/api/doctors/route.ts"
      to: "src/lib/auth.ts"
      via: "import requireOrgDsoAccess"
      pattern: "import.*requireOrgDsoAccess.*from.*auth"
    - from: "src/app/api/data-tables/[id]/route.ts"
      to: "src/lib/auth.ts"
      via: "import requireOrgDsoAccess"
      pattern: "import.*requireOrgDsoAccess.*from.*auth"
---

<objective>
Migrate all Category A (DSO-scoped) routes to use `requireOrgDsoAccess` instead of `requireDsoAccessWithFallback`/`checkDsoAccess`, and update GET/PATCH /api/dsos to filter by org.

Purpose: This is the bulk of the isolation work — after this plan, a user outside the org cannot access any DSO data even with crafted requests. Satisfies SC-5 (cross-org access blocked) for all DSO-scoped endpoints.

Output: 17 route files updated to use org-gated auth.
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-scope-all-routes-and-full-isolation/05-RESEARCH.md
@.planning/phases/05-scope-all-routes-and-full-isolation/05-01-SUMMARY.md
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core DSO-scoped routes to requireOrgDsoAccess</name>
  <files>
    src/app/api/doctors/route.ts
    src/app/api/doctors/[id]/route.ts
    src/app/api/doctors/[id]/periods/route.ts
    src/app/api/activities/route.ts
    src/app/api/tasks/route.ts
    src/app/api/progress/route.ts
    src/app/api/dsos/route.ts
  </files>
  <action>
For each route file listed, replace the existing DSO access check with `requireOrgDsoAccess`. The migration is mechanical — swap the call, update the import, and destructure the new return value.

**Pattern for routes using `requireDsoAccessWithFallback(request, dsoId)`:**
```typescript
// BEFORE:
const accessResult = await requireDsoAccessWithFallback(request, dsoId);
if ('response' in accessResult) return accessResult.response;

// AFTER:
const accessResult = await requireOrgDsoAccess(request, dsoId);
if ('response' in accessResult) return accessResult.response;
```

The return shape is compatible — both return `{ userId, role, response? }` (the new one also includes `orgId` which callers can ignore).

**Route-by-route instructions:**

1. **`GET /api/doctors`** — Two auth checks:
   - Line ~14: `requireAuthWithFallback` stays (handles the no-dso-id case for general listing)
   - Line ~21: `requireDsoAccessWithFallback(request, dsoId)` → `requireOrgDsoAccess(request, dsoId)`
   - **ALSO**: When `dsoId` is NOT provided, the route returns ALL doctors without any DSO filter. This is a Category B-like behavior. For now, leave this as-is (Plan 03 handles enumeration filtering). The org check only fires when `dsoId` is provided.
   - Update import: add `requireOrgDsoAccess`, keep `requireAuthWithFallback`

2. **`POST /api/doctors`** — Line ~106: `requireDsoAccessWithFallback(request, dso_id, true, body)` → `requireOrgDsoAccess(request, dso_id, true, body)`
   - Update import: add `requireOrgDsoAccess`

3. **`GET /api/doctors/[id]`** — Uses `requireAuthWithFallback` + manual `checkDsoAccess`. Replace the TWO-step check (auth + dso access) with a SINGLE `requireOrgDsoAccess(request, doctor.dso_id)` call. Remove the manual `checkDsoAccess` call.

4. **`PATCH /api/doctors/[id]`** — Same pattern as GET. Replace auth + checkDsoAccess with `requireOrgDsoAccess(request, doctor.dso_id, true)`.

5. **`DELETE /api/doctors/[id]`** — Same pattern. Replace with `requireOrgDsoAccess(request, doctor.dso_id, true)`.

6. **`GET /api/doctors/[id]/periods`** — Uses `requireDsoAccessWithFallback`. Replace with `requireOrgDsoAccess`.

7. **`PATCH /api/doctors/[id]/periods`** — Uses `requireDsoAccessWithFallback` with manual fallback. Replace with `requireOrgDsoAccess(request, dsoId, true, body)`.

8. **`GET /api/activities`** — Uses `requireAuthWithFallback` + `checkDsoAccess`. When `client_id` is provided, replace `checkDsoAccess(userId, clientId)` with `requireOrgDsoAccess(request, clientId)`.

9. **`POST /api/activities`** — Uses `requireAuth` + `checkDsoAccess`. Replace with `requireOrgDsoAccess(request, clientId, true, body)`.

10. **`GET /api/tasks`** — Uses `requireAuthWithFallback` + `checkDsoAccess`. When `dso_id` is provided, replace with `requireOrgDsoAccess(request, dsoId)`.

11. **`POST /api/tasks`** — Uses `requireAuthWithFallback` + `checkDsoAccess`. Replace with `requireOrgDsoAccess(request, dsoId, true, body)`.

12. **`GET /api/progress`** — Uses `requireDsoAccessWithFallback`. Replace with `requireOrgDsoAccess`.

13. **`GET /api/dsos`** — This is a Category B route (enumerates user's DSOs). Replace the `user_dso_access` query with an org-filtered version:
    - After identifying userId, call `getUserOrg(userId)` to get orgId
    - If no org, return empty `{ dsos: [], archivedDsos: [] }`
    - Change the `user_dso_access` query to join with `dsos` and filter by org:
      ```typescript
      const { data: accessRecords } = await supabaseAdmin
          .from('user_dso_access')
          .select('dso_id, dsos!inner(org_id)')
          .eq('user_id', userId)
          .eq('dsos.org_id', orgId);
      ```
    - Update import: add `getUserOrg`

14. **`PATCH /api/dsos`** — Uses `requireAuth` + manual `user_dso_access` check. Replace the manual check with `requireOrgDsoAccess(request, id, true, body)`. The DSO id comes from `body.id`.

For each file, update the import statement at the top to include `requireOrgDsoAccess` (and `getUserOrg` where needed) from `@/lib/auth`. Remove unused imports (e.g., `requireDsoAccessWithFallback` if no longer used in that file, `checkDsoAccess` if replaced).

CRITICAL: Do NOT remove the `user_id` fallback capability — `requireOrgDsoAccess` already handles this internally. If a route currently parses body to get `user_id`, pass `body` as the 4th argument to `requireOrgDsoAccess`.
  </action>
  <verify>Run `npx tsc --noEmit` — zero type errors. Run `npm run build` — build succeeds. Grep for `requireDsoAccessWithFallback` in modified files to confirm none remain (except dsos/route.ts POST which already uses org_members correctly).</verify>
  <done>All 7 core route files use `requireOrgDsoAccess` or `getUserOrg` for org-gated auth. No routes use the old `requireDsoAccessWithFallback`/`checkDsoAccess` as their sole auth check.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate all data-tables routes to requireOrgDsoAccess</name>
  <files>
    src/app/api/data-tables/route.ts
    src/app/api/data-tables/[id]/route.ts
    src/app/api/data-tables/[id]/columns/route.ts
    src/app/api/data-tables/[id]/columns/[columnId]/route.ts
    src/app/api/data-tables/[id]/rows/route.ts
    src/app/api/data-tables/[id]/rows/[rowId]/route.ts
    src/app/api/data-tables/[id]/rows/[rowId]/periods/route.ts
    src/app/api/data-tables/[id]/rows/[rowId]/periods/[periodId]/route.ts
    src/app/api/data-tables/[id]/periods/batch/route.ts
    src/app/api/data-tables/format-phones/route.ts
  </files>
  <action>
All data-tables routes follow the same pattern: they look up `table.client_id` (which is a DSO id), then call `requireDsoAccessWithFallback(request, table.client_id)` or `requireDsoAccess(request, table.client_id)`. The migration is uniform:

**For every data-tables route file:**

1. Replace `requireDsoAccessWithFallback(request, clientId/table.client_id, ...)` with `requireOrgDsoAccess(request, clientId/table.client_id, ...)`.
2. Replace `requireDsoAccess(request, clientId/table.client_id, ...)` with `requireOrgDsoAccess(request, clientId/table.client_id, ...)`.
3. Update the import at the top: replace `requireDsoAccess` and/or `requireDsoAccessWithFallback` with `requireOrgDsoAccess` from `@/lib/auth`.
4. If the route passes `body` as a 4th argument (for user_id fallback on POST/PUT), preserve that: `requireOrgDsoAccess(request, dsoId, true, body)`.

**Special cases:**

- **`POST /api/data-tables` (data-tables/route.ts)**: This route has a double-fallback pattern where it first calls `requireDsoAccessWithFallback`, and if that fails, checks `bodyUserId` manually against `user_dso_access`. Replace the ENTIRE auth block with a single `requireOrgDsoAccess(request, client_id, true, body)` call. The new helper already handles body fallback internally. Remove the manual `bodyUserId` fallback code block.

- **`POST /api/data-tables/format-phones`**: Uses `requireDsoAccessWithFallback` with body fallback. Replace with `requireOrgDsoAccess(request, dsoId, false, body)`.

For each file, remove unused imports (`requireDsoAccess`, `requireDsoAccessWithFallback`) after replacement.

All 10 data-tables route files should import `requireOrgDsoAccess` from `@/lib/auth` when done.
  </action>
  <verify>Run `npx tsc --noEmit` — zero type errors. Run `npm run build` — build succeeds. Grep for `requireDsoAccessWithFallback\|requireDsoAccess` in all data-tables route files to confirm none remain. Grep for `requireOrgDsoAccess` to confirm all are migrated.</verify>
  <done>All 10 data-tables route files use `requireOrgDsoAccess` for org-gated auth. The double-fallback pattern in POST /api/data-tables is simplified to a single call.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. All 17 route files import and use `requireOrgDsoAccess` or `getUserOrg`
4. No data-tables route files reference `requireDsoAccessWithFallback` or `requireDsoAccess`
5. `GET /api/dsos` filters by org via `getUserOrg` + org-filtered `user_dso_access` query
6. `PATCH /api/dsos` uses `requireOrgDsoAccess` for org + DSO access verification
7. POST /api/dsos is unchanged (already uses org_members lookup — confirmed in research)
</verification>

<success_criteria>
- Every DSO-scoped route (Category A) now verifies org membership before granting access
- A crafted request to a DSO outside the user's org returns 403
- The user_id fallback pattern is preserved on all routes
- Build and type-check pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-scope-all-routes-and-full-isolation/05-02-SUMMARY.md`
</output>
