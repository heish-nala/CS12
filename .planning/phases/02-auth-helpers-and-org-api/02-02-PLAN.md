---
phase: 02-auth-helpers-and-org-api
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/orgs/route.ts
  - src/app/api/orgs/[id]/route.ts
  - src/app/api/dsos/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/orgs creates an organization with a unique slug and returns 201 with the org object, inserting the creator as owner in org_members"
    - "POST /api/orgs returns 409 when the generated slug conflicts with an existing slug"
    - "GET /api/orgs returns only organizations the authenticated user belongs to"
    - "PATCH /api/orgs/[id] allows an owner or admin to rename the organization and the change persists"
    - "POST /api/dsos includes org_id in the insert by looking up the user's org, fixing the Phase 1 NOT NULL violation gap"
  artifacts:
    - path: "src/app/api/orgs/route.ts"
      provides: "GET (list user orgs) and POST (create org) endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/orgs/[id]/route.ts"
      provides: "GET (org detail) and PATCH (rename org) endpoints"
      exports: ["GET", "PATCH"]
    - path: "src/app/api/dsos/route.ts"
      provides: "Fixed POST handler that includes org_id from user's org membership"
      exports: ["GET", "POST", "PATCH"]
  key_links:
    - from: "src/app/api/orgs/route.ts"
      to: "src/lib/auth.ts"
      via: "requireAuth for POST, requireAuth for GET"
      pattern: "requireAuth"
    - from: "src/app/api/orgs/route.ts"
      to: "org_members table"
      via: "supabaseAdmin insert after org creation"
      pattern: "supabaseAdmin.*from.*org_members.*insert"
    - from: "src/app/api/orgs/[id]/route.ts"
      to: "src/lib/auth.ts"
      via: "requireOrgAccess for PATCH (owner/admin only)"
      pattern: "requireOrgAccess"
    - from: "src/app/api/dsos/route.ts"
      to: "org_members table"
      via: "query user's org before DSO insert"
      pattern: "supabaseAdmin.*from.*org_members"
---

<objective>
Build the organization CRUD API endpoints (create, list, detail, rename) and fix the broken POST /api/dsos route that was identified in Phase 1 verification.

Purpose: These endpoints allow organization creation and management (ORG-02, ORG-03), and fixing the DSO create route restores full zero-downtime (the Phase 1 verification gap). GET /api/orgs is also needed by Phase 4 for the org context provider.

Output: Three route files — two new (orgs CRUD), one fixed (dsos POST with org_id).
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-helpers-and-org-api/02-RESEARCH.md
@.planning/phases/02-auth-helpers-and-org-api/02-01-SUMMARY.md
@src/lib/auth.ts
@src/lib/org-utils.ts
@src/app/api/dsos/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /api/orgs route (GET list + POST create)</name>
  <files>src/app/api/orgs/route.ts</files>
  <action>
  Create `src/app/api/orgs/route.ts` with GET and POST handlers following the existing route pattern (see `src/app/api/dsos/route.ts`).

  **GET /api/orgs** — List organizations the user belongs to:
  1. Call `requireAuth(request)`. If error, return the error response.
  2. Query `org_members` filtered by `user_id = user.id`, joining with `organizations`:
     ```typescript
     const { data, error } = await supabaseAdmin
         .from('org_members')
         .select('role, organizations(*)')
         .eq('user_id', user.id);
     ```
  3. Transform the response to return `{ orgs: [...] }` where each item includes the org object and the user's role.
  4. Return 200.

  **POST /api/orgs** — Create a new organization:
  1. Call `requireAuth(request)`. If error, return the error response.
  2. Parse the request body. Validate that `name` is present and is a non-empty string (1-100 chars). Use simple validation — do NOT import zod for just one field check.
  3. Generate slug using `generateOrgSlug(name)` from `src/lib/org-utils.ts`. If the slug is empty after sanitization, return 400 with `{ error: 'Organization name must contain at least one alphanumeric character' }`.
  4. Insert into `organizations` table: `{ name, slug, created_by: user.id }`.
  5. If the insert error has code `'23505'` (unique constraint violation on slug), return 409 with `{ error: 'An organization with this name already exists. Please choose a different name.' }`.
  6. If insert succeeds, immediately insert into `org_members`: `{ org_id: data.id, user_id: user.id, role: 'owner' }`.
  7. If the org_members insert fails, rollback by deleting the organization (same pattern as POST /api/dsos lines 141-152).
  8. Return 201 with `{ org: data }`.

  **Imports needed:**
  ```typescript
  import { NextRequest, NextResponse } from 'next/server';
  import { supabaseAdmin } from '@/lib/db/client';
  import { requireAuth } from '@/lib/auth';
  import { generateOrgSlug } from '@/lib/org-utils';
  ```
  </action>
  <verify>Run `npx tsc --noEmit`. Verify file exists: `ls src/app/api/orgs/route.ts`. Verify exports: `grep "export async function" src/app/api/orgs/route.ts` shows GET and POST.</verify>
  <done>GET /api/orgs returns the user's organizations with their role. POST /api/orgs creates an org with unique slug, inserts creator as owner, handles 409 on slug collision, and rolls back org on failed member insert. Both use requireAuth.</done>
</task>

<task type="auto">
  <name>Task 2: Create /api/orgs/[id] route (GET detail + PATCH rename)</name>
  <files>src/app/api/orgs/[id]/route.ts</files>
  <action>
  Create `src/app/api/orgs/[id]/route.ts` with GET and PATCH handlers.

  **GET /api/orgs/[id]** — Get organization detail:
  1. Extract `id` from the route params: `const { id } = await params;` (Next.js 16 async params).
  2. Call `requireOrgAccess(request, id)`. If error, return the error response. This enforces that only org members can view org details.
  3. Query `organizations` by id: `supabaseAdmin.from('organizations').select('*').eq('id', id).single()`.
  4. If not found, return 404 with `{ error: 'Organization not found' }`.
  5. Return 200 with `{ org: data, role }` (include the user's role from requireOrgAccess).

  **PATCH /api/orgs/[id]** — Rename organization (ORG-03):
  1. Extract `id` from the route params.
  2. Call `requireOrgAccess(request, id, true)` — the `true` parameter means requireOwnerOrAdmin. Only owners and admins can rename.
  3. Parse request body. Validate `name` is present and is a non-empty string (1-100 chars). No other fields are updatable in Phase 2.
  4. Optionally regenerate slug from the new name. However, per the research anti-pattern note, do NOT auto-generate a new slug — slugs should be stable identifiers. Only update the `name` field:
     ```typescript
     const { data, error } = await supabaseAdmin
         .from('organizations')
         .update({ name })
         .eq('id', id)
         .select()
         .single();
     ```
  5. Return 200 with `{ org: data }`.

  **Route signature for Next.js 16 App Router dynamic routes:**
  ```typescript
  export async function GET(
      request: NextRequest,
      { params }: { params: Promise<{ id: string }> }
  ) {
      const { id } = await params;
      // ...
  }
  ```

  **Imports needed:**
  ```typescript
  import { NextRequest, NextResponse } from 'next/server';
  import { supabaseAdmin } from '@/lib/db/client';
  import { requireOrgAccess } from '@/lib/auth';
  ```
  </action>
  <verify>Run `npx tsc --noEmit`. Verify file exists: `ls src/app/api/orgs/\[id\]/route.ts`. Verify exports: `grep "export async function" src/app/api/orgs/\[id\]/route.ts` shows GET and PATCH.</verify>
  <done>GET /api/orgs/[id] returns org detail for members only. PATCH /api/orgs/[id] allows owner/admin to rename. Both use requireOrgAccess with the correct role checks. Next.js 16 async params pattern used.</done>
</task>

<task type="auto">
  <name>Task 3: Fix POST /api/dsos to include org_id (Phase 1 gap closure)</name>
  <files>src/app/api/dsos/route.ts</files>
  <action>
  Fix the known Phase 1 verification gap: POST /api/dsos at line 123-128 inserts `{ name }` only, but `dsos.org_id` is NOT NULL.

  **Change the POST handler** in `src/app/api/dsos/route.ts`:

  1. After the auth check (around line 103-113) and before the DSO insert (line 123), add a query to find the user's organization:
     ```typescript
     // Look up user's org (for v1, user has one org)
     const { data: membership, error: memberError } = await supabaseAdmin
         .from('org_members')
         .select('org_id')
         .eq('user_id', user_id)
         .limit(1)
         .single();

     if (memberError || !membership) {
         return NextResponse.json(
             { error: 'You must belong to an organization to create a client' },
             { status: 400 }
         );
     }
     ```

  2. Update the insert on line 123-127 to include `org_id`:
     ```typescript
     const { data, error } = await supabaseAdmin
         .from('dsos')
         .insert({ name, org_id: membership.org_id })
         .select()
         .single();
     ```

  **Do NOT change** the GET or PATCH handlers — they are unaffected by this bug.

  **Do NOT change** the auth fallback pattern (user_id from body) — that is a separate concern.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify the insert now includes org_id: `grep "org_id" src/app/api/dsos/route.ts` should show `org_id: membership.org_id` in the insert. Run `npm run build` to confirm full build passes.</verify>
  <done>POST /api/dsos now looks up the user's org via org_members and includes org_id in the dsos insert. The Phase 1 NOT NULL violation gap is closed. Creating a new DSO works for any user who belongs to an organization.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` passes (full Next.js build)
3. `ls src/app/api/orgs/route.ts src/app/api/orgs/\[id\]/route.ts` — both files exist
4. `grep "org_id" src/app/api/dsos/route.ts` — confirms org_id is included in the DSO insert
5. `grep "23505" src/app/api/orgs/route.ts` — confirms 409 handling for duplicate slug
6. `grep "requireOrgAccess" src/app/api/orgs/\[id\]/route.ts` — confirms org access check on detail/rename routes
</verification>

<success_criteria>
- POST /api/orgs creates an org with unique slug, adds creator as owner, returns 201
- POST /api/orgs returns 409 on duplicate slug (not 500)
- GET /api/orgs returns only the authenticated user's organizations
- PATCH /api/orgs/[id] allows owner/admin to rename, rejects members with 403
- POST /api/dsos includes org_id in the insert, closing the Phase 1 verification gap
- Full build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-helpers-and-org-api/02-02-SUMMARY.md`
</output>
