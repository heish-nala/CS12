---
phase: 02-auth-helpers-and-org-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth.ts
  - src/lib/db/types.ts
  - src/lib/org-utils.ts
autonomous: true

must_haves:
  truths:
    - "checkOrgMembership() returns { isMember: true, role } for a valid org member and { isMember: false, role: null } for a non-member"
    - "requireOrgAccess() returns { user, role } for authorized requests and { response: 401|403 } for unauthorized/forbidden requests"
    - "requireOrgAccess() with requireOwnerOrAdmin=true rejects members who are not owner or admin with a 403"
    - "OrgRole, Organization, OrgMember, UserProfile types exist and match the Phase 1 database schema exactly"
    - "generateOrgSlug() converts org names to URL-safe lowercase hyphenated strings"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "checkOrgMembership and requireOrgAccess helper functions"
      exports: ["checkOrgMembership", "requireOrgAccess"]
    - path: "src/lib/db/types.ts"
      provides: "Organization, OrgMember, UserProfile, OrgRole type definitions"
      contains: "OrgRole"
    - path: "src/lib/org-utils.ts"
      provides: "generateOrgSlug utility function and VALID_ORG_ROLES constant"
      exports: ["generateOrgSlug", "VALID_ORG_ROLES", "isValidOrgRole"]
  key_links:
    - from: "src/lib/auth.ts"
      to: "org_members table"
      via: "supabaseAdmin.from('org_members')"
      pattern: "supabaseAdmin.*from.*org_members"
    - from: "src/lib/auth.ts"
      to: "src/lib/auth.ts"
      via: "requireOrgAccess calls getAuthUser then checkOrgMembership"
      pattern: "getAuthUser.*checkOrgMembership"
---

<objective>
Add org membership auth helpers to lib/auth.ts, org-related TypeScript types to lib/db/types.ts, and a slug generation utility to a new org-utils module.

Purpose: Every subsequent plan in Phase 2 (and Phases 3-5) will call requireOrgAccess() or checkOrgMembership() in route handlers. The types and slug utility are used by the org CRUD routes in Plan 02. This plan establishes the foundation all org-aware code depends on.

Output: Three files updated/created with exported functions and types ready for import by route handlers.
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-helpers-and-org-api/02-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md
@src/lib/auth.ts
@src/lib/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add org TypeScript types and slug utility</name>
  <files>src/lib/db/types.ts, src/lib/org-utils.ts</files>
  <action>
  **In src/lib/db/types.ts**, add the following type definitions after the existing `UserRole` type (around line 8):

  ```typescript
  export type OrgRole = 'owner' | 'admin' | 'member';
  ```

  Then add the following interfaces after the existing `UserDSOAccess` interface (around line 109):

  ```typescript
  export interface Organization {
      id: string;
      name: string;
      slug: string;
      created_by: string | null;
      created_at: string;
      updated_at: string;
  }

  export interface OrgMember {
      id: string;
      org_id: string;
      user_id: string;
      role: OrgRole;
      joined_at: string;
  }

  export interface UserProfile {
      id: string;
      email: string;
      name: string | null;
      created_at: string;
      updated_at: string;
  }

  export interface OrgMemberWithProfile extends OrgMember {
      user_profiles: UserProfile | null;
  }
  ```

  Note: `OrgMemberWithProfile` uses `user_profiles` (not `profile`) because that is the Supabase join key name when doing `.select('*, user_profiles(*)')` on org_members.

  **Create src/lib/org-utils.ts** with:

  ```typescript
  export const VALID_ORG_ROLES = ['owner', 'admin', 'member'] as const;
  export type OrgRole = typeof VALID_ORG_ROLES[number];

  export function isValidOrgRole(role: string): role is OrgRole {
      return (VALID_ORG_ROLES as readonly string[]).includes(role);
  }

  export function generateOrgSlug(name: string): string {
      return name
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '');
  }
  ```

  The `OrgRole` type is defined in BOTH files intentionally — types.ts has it for database type contracts, org-utils.ts has it derived from the runtime constant for validation logic. They are identical.
  </action>
  <verify>Run `npx tsc --noEmit` from the project root. Zero type errors related to the new types. Verify the file exists: `ls src/lib/org-utils.ts`.</verify>
  <done>OrgRole, Organization, OrgMember, UserProfile, OrgMemberWithProfile types exist in types.ts. generateOrgSlug, VALID_ORG_ROLES, isValidOrgRole are exported from org-utils.ts. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add checkOrgMembership and requireOrgAccess to auth.ts</name>
  <files>src/lib/auth.ts</files>
  <action>
  Add two new exported functions to `src/lib/auth.ts`, placed AFTER the existing `requireDsoAccessWithFallback` function (after line 247). These follow the exact same discriminated union pattern as `requireDsoAccess` (line 145).

  **Function 1: checkOrgMembership**

  ```typescript
  /**
   * Check if user is a member of a specific organization
   */
  export async function checkOrgMembership(
      userId: string,
      orgId: string
  ): Promise<{ isMember: boolean; role: string | null }> {
      try {
          const { data, error } = await supabaseAdmin
              .from('org_members')
              .select('role')
              .eq('user_id', userId)
              .eq('org_id', orgId)
              .single();

          if (error || !data) {
              return { isMember: false, role: null };
          }
          return { isMember: true, role: data.role };
      } catch (error) {
          console.error('Org membership check error:', error);
          return { isMember: false, role: null };
      }
  }
  ```

  **Function 2: requireOrgAccess**

  ```typescript
  /**
   * Middleware helper to require organization membership
   * Returns an error response if not a member, or the user + role if authorized
   */
  export async function requireOrgAccess(
      request: NextRequest,
      orgId: string,
      requireOwnerOrAdmin = false
  ): Promise<
      { user: AuthUser; role: string; response?: never } |
      { user?: never; role?: never; response: NextResponse }
  > {
      const { user, error } = await getAuthUser(request);

      if (!user) {
          return {
              response: NextResponse.json(
                  { error: error || 'Unauthorized' },
                  { status: 401 }
              ),
          };
      }

      const { isMember, role } = await checkOrgMembership(user.id, orgId);

      if (!isMember) {
          return {
              response: NextResponse.json(
                  { error: 'Not a member of this organization' },
                  { status: 403 }
              ),
          };
      }

      if (requireOwnerOrAdmin && role !== 'owner' && role !== 'admin') {
          return {
              response: NextResponse.json(
                  { error: 'Owner or admin access required' },
                  { status: 403 }
              ),
          };
      }

      return { user, role: role! };
  }
  ```

  Do NOT modify any existing functions. The new functions are additive only.

  **Usage pattern (identical to requireDsoAccess):**
  ```typescript
  const orgResult = await requireOrgAccess(request, orgId);
  if ('response' in orgResult) return orgResult.response;
  const { user, role } = orgResult;
  ```
  </action>
  <verify>Run `npx tsc --noEmit` from the project root. Zero type errors. Verify both functions are exported: `grep -n "export async function" src/lib/auth.ts` should show checkOrgMembership and requireOrgAccess in the list.</verify>
  <done>checkOrgMembership and requireOrgAccess are exported from src/lib/auth.ts. Both follow the exact same discriminated union pattern as the existing DSO helpers. TypeScript compiles without errors. No existing functions were modified.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep "export" src/lib/org-utils.ts` shows generateOrgSlug, VALID_ORG_ROLES, isValidOrgRole
3. `grep "export async function" src/lib/auth.ts` shows checkOrgMembership and requireOrgAccess alongside existing functions
4. `grep "OrgRole\|Organization\|OrgMember\|UserProfile" src/lib/db/types.ts` shows all 4 type definitions
5. `npm run build` passes (full Next.js build, not just tsc)
</verification>

<success_criteria>
- Auth helpers checkOrgMembership and requireOrgAccess exist in auth.ts and follow the discriminated union pattern
- TypeScript types for Organization, OrgMember, UserProfile, OrgRole match Phase 1 schema
- generateOrgSlug utility and VALID_ORG_ROLES constant are importable from org-utils.ts
- Full build passes — no type errors, no import errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-helpers-and-org-api/02-01-SUMMARY.md`
</output>
