---
phase: 03-invite-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/team/invite/route.ts
  - src/app/api/team/accept-invite/route.ts
  - supabase/migrations/20260227100000_add_org_invites.sql
autonomous: true

must_haves:
  truths:
    - "Inviting an existing user to a DSO grants access to ONLY that DSO, not all of the inviter's DSOs"
    - "Accepting a pending team_invite grants access to ONLY the invite's dso_id, not all of the inviter's DSOs"
    - "The org_invites table exists with org_id, email, role, invited_by, status, expires_at columns"
  artifacts:
    - path: "src/app/api/team/invite/route.ts"
      provides: "Fixed invite sender — existing user branch grants only the single dso_id"
      contains: "dso_id: dso_id"
    - path: "src/app/api/team/accept-invite/route.ts"
      provides: "Fixed invite acceptor — grants only invite.dso_id per invite"
      contains: "dso_id: invite.dso_id"
    - path: "supabase/migrations/20260227100000_add_org_invites.sql"
      provides: "org_invites table scoped to org_id with pending/accepted/expired/cancelled status"
      contains: "CREATE TABLE org_invites"
  key_links:
    - from: "supabase/migrations/20260227100000_add_org_invites.sql"
      to: "organizations table"
      via: "REFERENCES organizations(id)"
      pattern: "REFERENCES organizations\\(id\\)"
---

<objective>
Fix the existing invite bug that grants invitees access to ALL of the inviter's DSOs, and create the org_invites table for the new org-scoped invite system.

Purpose: The bug is a cross-org data leak risk (ISO-04). The org_invites table is required by Plan 02's invite send/accept endpoints. Both are Phase 3 prerequisites.

Output: Two fixed route files (team invite and accept-invite) + one new migration file (org_invites table).
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-invite-system/03-RESEARCH.md

@src/app/api/team/invite/route.ts
@src/app/api/team/accept-invite/route.ts
@supabase/migrations/20250115_add_team_invites.sql
@supabase/migrations/20260226000000_add_org_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix existing invite bug in team invite and accept-invite routes</name>
  <files>
    src/app/api/team/invite/route.ts
    src/app/api/team/accept-invite/route.ts
  </files>
  <action>
**Fix 1 — `POST /api/team/invite` (existing user branch, lines 87–150):**

Remove the "all inviter's DSOs" expansion logic. The existing user branch currently:
1. Fetches `inviterAccess` (ALL DSOs the inviter has)
2. Computes `missingDsoIds` relative to all inviter DSOs
3. Inserts access to ALL missing inviter DSOs

Replace with: Grant access ONLY to the single `dso_id` from the request body.

Specifically:
- Delete the `inviterAccess` query (`.from('user_dso_access').select('dso_id').eq('user_id', currentUser.id)`)
- Delete the `inviterDsoIds` computation
- Delete the `existingAccess` / `existingDsoIds` / `missingDsoIds` filtering logic
- Replace with a simple check: does the existing user already have access to THIS `dso_id`?
  - If yes: return 400 "User already has access to this workspace"
  - If no: insert a single row `{ user_id: existingUser.id, dso_id: dso_id, role: role }`
- Keep the stale invite cleanup (marking pending invites as accepted) — it's fine
- Keep the response shape (`added_directly: true`)

Also fix the anti-pattern on line 82-85: `listUsers()` fetches ALL users. Replace with a query to `user_profiles` table by email (added in Phase 1 for exactly this purpose):
```typescript
const { data: existingProfile } = await supabaseAdmin
    .from('user_profiles')
    .select('id, email')
    .eq('email', normalizedEmail)
    .single();
```
If `existingProfile` exists, use `existingProfile.id` as the user ID. If not, proceed with the `inviteUserByEmail` path (new user).

**Fix 2 — `POST /api/team/accept-invite` (lines 65–131):**

Remove the "all inviter's DSOs" expansion logic. The loop currently:
1. For each invite, fetches `inviterAccess` (ALL DSOs the inviter has)
2. Computes `allDsoIds` and `missingDsoIds`
3. Inserts access to ALL missing inviter DSOs

Replace with: Grant access ONLY to `invite.dso_id` for each pending invite.

Specifically, for each invite in the loop:
- Delete the `inviterAccess` query
- Delete the `allDsoIds`, `existingAccess`, `existingDsoIds`, `missingDsoIds` logic
- Replace with a single insert: `{ user_id: actualUserId, dso_id: invite.dso_id, role: invite.role }`
- Use `.insert(...).select()` with no throwOnError — check error. If error code `23505` (duplicate), skip silently (already has access). If other error, log and continue.
- Keep the invite status update to 'accepted'
- Update the DSO name lookup to use `invite.dso_id` instead of `missingDsoIds`
  </action>
  <verify>
1. `npm run build` passes with no type errors
2. Read both files and confirm: NO query for inviterAccess / inviterDsoIds / allDsoIds remains
3. Confirm: The only dso_id being inserted is the single `dso_id` from the invite, not a list
4. Confirm: `listUsers()` is no longer called in invite/route.ts — replaced with user_profiles query
  </verify>
  <done>
Both routes grant access to ONLY the specific DSO from the invite, not all of the inviter's DSOs. The `listUsers()` anti-pattern is eliminated. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create org_invites table migration</name>
  <files>
    supabase/migrations/20260227100000_add_org_invites.sql
  </files>
  <action>
Create a new migration file that adds the `org_invites` table. This is a completely separate table from `team_invites` — org-scoped, not DSO-scoped.

Schema (from research):

```sql
-- ==========================================================
-- 1. Create org_invites table
-- ==========================================================
-- Stores org-level invitations. Separate from team_invites (DSO-level).
-- Roles are org roles (owner/admin/member), not DSO roles (admin/manager/viewer).

CREATE TABLE org_invites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
    invited_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled')),
    expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days'),
    accepted_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (org_id, email, status)  -- one pending invite per email per org
);

-- ==========================================================
-- 2. Indexes for lookups
-- ==========================================================

CREATE INDEX idx_org_invites_org_id ON org_invites(org_id);
CREATE INDEX idx_org_invites_email ON org_invites(email);
CREATE INDEX idx_org_invites_status ON org_invites(status);
```

Notes:
- Do NOT add RLS policies — consistent with Phase 1 decision (supabaseAdmin bypasses RLS, adding it would be dead code)
- Do NOT drop or modify `team_invites` — Phase 5 will deprecate the old model
- Use `gen_random_uuid()` (not `uuid_generate_v4()`) — consistent with Phase 1 migration pattern for `organizations` table
- `invited_by` references `auth.users(id)` as UUID (not TEXT) — matches the `organizations` table pattern
- Migration section headers follow the established pattern: numbered headers with `==========` separators
  </action>
  <verify>
1. Validate the SQL syntax is correct by reading the file and checking: CREATE TABLE, REFERENCES, CHECK constraints, UNIQUE constraint, CREATE INDEX statements are all present
2. Confirm `gen_random_uuid()` is used (not `uuid_generate_v4()`)
3. Confirm no RLS policies are defined (consistent with Phase 1 decision)
4. Confirm the migration file is sorted correctly by timestamp among existing migrations
  </verify>
  <done>
The `org_invites` migration file exists at `supabase/migrations/20260227100000_add_org_invites.sql` with the correct schema: org_id FK to organizations, email, role with org-role CHECK, invited_by FK to auth.users, status, expires_at, UNIQUE constraint, and 3 indexes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes — no type errors from the fixed invite routes
2. Both fixed routes contain NO references to `inviterAccess`, `inviterDsoIds`, `allDsoIds`, or `missingDsoIds`
3. `listUsers()` is not called anywhere in the fixed invite route
4. org_invites migration SQL has correct REFERENCES to organizations(id) and auth.users(id)
5. Both old and new tables coexist — team_invites is untouched
</verification>

<success_criteria>
- The existing invite bug (ISO-04) is fixed — inviter's DSOs are no longer expanded
- org_invites table schema is ready for Plan 02's API endpoints
- Build passes with zero errors
- No existing functionality is broken (team_invites table and its routes still exist)
</success_criteria>

<output>
After completion, create `.planning/phases/03-invite-system/03-01-SUMMARY.md`
</output>
