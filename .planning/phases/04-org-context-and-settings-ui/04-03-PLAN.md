---
phase: 04-org-context-and-settings-ui
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/app/settings/page.tsx
  - src/components/settings/org-settings.tsx
  - src/components/settings/dso-assignment-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Settings page has an 'Organization' tab that shows org name and member list with org roles"
    - "Each member row shows which DSOs they are assigned to"
    - "Admin/owner can click a member to open a DSO assignment dialog with checkboxes for all org DSOs"
    - "Admin/owner can add or remove DSO access and the change takes effect on next page load"
    - "Non-admin members can see their own DSO assignments but cannot modify anyone's access"
    - "Role-based UI: edit controls visible only to owner/admin (from OrgContext, not hardcoded)"
  artifacts:
    - path: "src/app/settings/page.tsx"
      provides: "Organization tab in settings"
      contains: "organization"
    - path: "src/components/settings/org-settings.tsx"
      provides: "Org settings component with member list and DSO assignments"
      exports: ["OrgSettings"]
    - path: "src/components/settings/dso-assignment-dialog.tsx"
      provides: "Modal dialog for managing DSO assignments per member"
      exports: ["DsoAssignmentDialog"]
  key_links:
    - from: "src/components/settings/org-settings.tsx"
      to: "src/contexts/org-context.tsx"
      via: "useOrg hook"
      pattern: "useOrg"
    - from: "src/components/settings/org-settings.tsx"
      to: "/api/orgs/[id]/members"
      via: "fetch"
      pattern: "fetch.*api/orgs.*members"
    - from: "src/components/settings/org-settings.tsx"
      to: "/api/orgs/[id]/dso-access"
      via: "fetch"
      pattern: "fetch.*api/orgs.*dso-access"
    - from: "src/components/settings/dso-assignment-dialog.tsx"
      to: "/api/orgs/[id]/dso-access"
      via: "fetch POST/DELETE"
      pattern: "fetch.*api/orgs.*dso-access"
    - from: "src/components/settings/dso-assignment-dialog.tsx"
      to: "/api/orgs/[id]/dsos"
      via: "fetch GET (all org DSOs)"
      pattern: "fetch.*api/orgs.*dsos"
---

<objective>
Build the Organization settings tab with member list, DSO assignment display, and DSO assignment management dialog.

Purpose: This plan delivers the three Phase 4 requirements: UI-01 (org settings page with members + DSO assignments), UI-02 (member sees their DSO assignments), and UI-03 (admin manages DSO assignments). It uses OrgContext from Plan 02 for the user's role and the API routes from Plan 01 for DSO access data.

Output: New Organization tab in settings, OrgSettings component, DsoAssignmentDialog component.
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-org-context-and-settings-ui/04-RESEARCH.md
@.planning/phases/04-org-context-and-settings-ui/04-01-SUMMARY.md
@.planning/phases/04-org-context-and-settings-ui/04-02-SUMMARY.md
@src/app/settings/page.tsx
@src/components/settings/team-members.tsx
@src/contexts/org-context.tsx
@src/lib/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrgSettings component with member list and DSO assignments</name>
  <files>src/components/settings/org-settings.tsx</files>
  <action>
Create `src/components/settings/org-settings.tsx` — the main component for the Organization settings tab.

**Imports:**
- `'use client'` directive
- React: `useState, useEffect, useCallback, useMemo`
- shadcn: `Badge`, `Button`, `Skeleton` (or a simple loading div)
- lucide: `Shield, Crown, User, Building2, Pencil` (reuse existing icon imports pattern)
- `useOrg` from `@/contexts/org-context`
- `useAuth` from `@/contexts/auth-context`
- `OrgMemberWithProfile` from `@/lib/db/types`
- `DsoAssignmentDialog` from `./dso-assignment-dialog`
- `toast` from `sonner`

**Types:**
```typescript
interface DsoAccessRow {
    user_id: string;
    dso_id: string;
    role: string;
}

interface DsoInfo {
    id: string;
    name: string;
}
```

**ORG_ROLE_CONFIG** (similar to ROLE_CONFIG in team-members.tsx but for org roles):
```typescript
const ORG_ROLE_CONFIG: Record<string, { label: string; icon: React.ReactNode; color: string }> = {
    owner: {
        label: 'Owner',
        icon: <Crown className="h-3.5 w-3.5" />,
        color: 'bg-[var(--notion-yellow)] text-[var(--notion-yellow-text)]',
    },
    admin: {
        label: 'Admin',
        icon: <Shield className="h-3.5 w-3.5" />,
        color: 'bg-[var(--notion-purple)] text-[var(--notion-purple-text)]',
    },
    member: {
        label: 'Member',
        icon: <User className="h-3.5 w-3.5" />,
        color: 'bg-[var(--notion-gray)] text-[var(--notion-gray-text)]',
    },
};
```

**Component structure:**

1. **State:**
   - `members`: `OrgMemberWithProfile[]` — from GET /api/orgs/[id]/members
   - `dsoAccess`: `DsoAccessRow[]` — from GET /api/orgs/[id]/dso-access
   - `allDsos`: `DsoInfo[]` — from GET /api/orgs/[id]/dsos
   - `loading`: boolean
   - `selectedMember`: `OrgMemberWithProfile | null` — for the assignment dialog
   - `dialogOpen`: boolean

2. **Derive `canManage`** from OrgContext: `const { org } = useOrg(); const canManage = org?.role === 'owner' || org?.role === 'admin';`

3. **`fetchData` callback:** Fetch all three endpoints in parallel when `org?.id` is available:
   ```
   Promise.all([
       fetch(`/api/orgs/${org.id}/members`),
       fetch(`/api/orgs/${org.id}/dso-access`),
       fetch(`/api/orgs/${org.id}/dsos`),
   ])
   ```
   Parse all responses, set state. If dso-access returns 403 (non-admin), set `dsoAccess` to empty array (non-admins can't see all access). For non-admins, skip the dso-access and dsos calls entirely — they only need the member list.

   Actually, rethink: for non-admin members who should see their OWN DSO assignments (UI-02), we can derive their DSOs from the existing ClientsContext (which already has their DSO list). So:
   - Admin/owner: fetch all 3 endpoints
   - Member: fetch only members list; for their own DSOs, read from ClientsContext

4. **Build `accessByUser`** lookup: `useMemo` that groups `dsoAccess` by `user_id` → `Map<string, string[]>` (user_id → dso_id[]).

5. **Build `dsoNameMap`** lookup: `useMemo` from `allDsos` → `Map<string, string>` (dso_id → name).

6. **Render layout:**

   **Header section:**
   ```
   <div className="rounded-xl border border-border/50 p-6 bg-card shadow-sm mb-6">
       <h3 className="font-semibold text-foreground mb-1">Organization</h3>
       <p className="text-lg text-foreground">{org?.name ?? '—'}</p>
   </div>
   ```

   **Members section:**
   ```
   <div className="rounded-xl border border-border/50 bg-card shadow-sm">
       <div className="p-4 border-b border-border/50">
           <h3 className="font-semibold text-foreground">Members</h3>
           <p className="text-sm text-muted-foreground">
               {members.length} member{members.length !== 1 ? 's' : ''} in this organization
           </p>
       </div>
       <div className="divide-y divide-border/50">
           {members.map(member => <MemberRow ... />)}
       </div>
   </div>
   ```

   **Each member row shows:**
   - User avatar (first letter of email, colored circle — same pattern as sidebar footer)
   - Name (from `member.user_profiles?.name`) or email prefix
   - Email (from `member.user_profiles?.email`)
   - Org role badge (from ORG_ROLE_CONFIG)
   - DSO assignment badges: for admin, show all DSOs from `accessByUser.get(member.user_id)` mapped through `dsoNameMap`. For non-admin viewing themselves, show DSOs from ClientsContext. For non-admin viewing others, show nothing (or "—").
   - If `canManage` and member is not the current user viewing their OWN owner role: show an "Edit DSOs" button (Pencil icon) that sets `selectedMember` and opens the dialog.

   **Note on "My Access" for non-admins:** When the logged-in user is a non-admin member, show a "Your DSO Access" section at the top listing the DSOs they're assigned to (from ClientsContext `clients` array). This satisfies UI-02 without requiring the non-admin to call admin-only endpoints.

7. **Loading state:** Show skeleton rows while loading.

8. **DsoAssignmentDialog:** Render at the bottom of the component:
   ```
   <DsoAssignmentDialog
       open={dialogOpen}
       onOpenChange={setDialogOpen}
       member={selectedMember}
       orgId={org?.id ?? ''}
       allDsos={allDsos}
       currentAssignments={selectedMember ? (accessByUser.get(selectedMember.user_id) ?? []) : []}
       onSave={() => { setDialogOpen(false); fetchData(); }}
   />
   ```

**Style:** Match the existing settings page card style (rounded-xl, border-border/50, bg-card, shadow-sm) — identical to what's in team-members.tsx and the workspace tab.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Grep for `useOrg` and `canManage` to confirm role-based UI. Grep for `fetch.*api/orgs` to confirm all three data fetches.
  </verify>
  <done>
OrgSettings component renders org name header, member list with org roles, DSO assignment badges per member, and "Edit DSOs" button for admins. Non-admin members see their own DSO list. Component reads from OrgContext for role-based visibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DsoAssignmentDialog and add Organization tab to settings page</name>
  <files>src/components/settings/dso-assignment-dialog.tsx, src/app/settings/page.tsx</files>
  <action>
**Part A: Create `src/components/settings/dso-assignment-dialog.tsx`**

A modal dialog where admins toggle DSO assignments for a selected member.

**Imports:**
- `'use client'` directive
- React: `useState, useEffect`
- shadcn: `Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter`, `Checkbox`, `Button`, `Label`
- `OrgMemberWithProfile` from `@/lib/db/types`
- `toast` from `sonner`
- lucide: `Building2, Loader2`

**Props interface:**
```typescript
interface DsoAssignmentDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    member: OrgMemberWithProfile | null;
    orgId: string;
    allDsos: Array<{ id: string; name: string }>;
    currentAssignments: string[]; // dso_ids
    onSave: () => void;
}
```

**Component implementation:**
1. State: `selected` (Set<string> initialized from `currentAssignments`), `saving` (boolean)
2. `useEffect`: When `open` changes to true or `currentAssignments` changes, reset `selected` to a new Set from `currentAssignments`.
3. `handleToggle(dsoId)`: Add or remove from `selected` set.
4. `handleSave`:
   - Compute diff: `toAdd` = in selected but not in currentAssignments; `toRemove` = in currentAssignments but not in selected
   - If no changes: close dialog, return
   - Set `saving = true`
   - For each dso in `toAdd`: `fetch(\`/api/orgs/${orgId}/dso-access\`, { method: 'POST', body: JSON.stringify({ user_id: member.user_id, dso_id: dso }) })`
   - For each dso in `toRemove`: `fetch(\`/api/orgs/${orgId}/dso-access?user_id=${member.user_id}&dso_id=${dso}\`, { method: 'DELETE' })`
   - Use `Promise.all` for all operations
   - Check responses: if any failed, `toast.error('Some changes failed. Please try again.')`
   - Otherwise: `toast.success('DSO assignments updated')`
   - Set `saving = false`
   - Call `onSave()` (parent closes dialog and refetches)

5. **Render:**
   ```
   <Dialog open={open} onOpenChange={onOpenChange}>
       <DialogContent className="sm:max-w-md">
           <DialogHeader>
               <DialogTitle>
                   Manage DSO Access — {member?.user_profiles?.name || member?.user_profiles?.email || 'Member'}
               </DialogTitle>
           </DialogHeader>
           <div className="py-4 space-y-3 max-h-[400px] overflow-y-auto">
               {allDsos.map(dso => (
                   <label key={dso.id} className="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-accent cursor-pointer">
                       <Checkbox
                           checked={selected.has(dso.id)}
                           onCheckedChange={() => handleToggle(dso.id)}
                           disabled={saving}
                       />
                       <Building2 className="h-4 w-4 text-muted-foreground shrink-0" />
                       <span className="text-sm text-foreground">{dso.name}</span>
                   </label>
               ))}
               {allDsos.length === 0 && (
                   <p className="text-sm text-muted-foreground text-center py-4">
                       No DSOs in this organization yet
                   </p>
               )}
           </div>
           <DialogFooter>
               <Button variant="outline" onClick={() => onOpenChange(false)} disabled={saving}>
                   Cancel
               </Button>
               <Button onClick={handleSave} disabled={saving}>
                   {saving ? <><Loader2 className="h-4 w-4 mr-2 animate-spin" />Saving...</> : 'Save Changes'}
               </Button>
           </DialogFooter>
       </DialogContent>
   </Dialog>
   ```

**Part B: Modify `src/app/settings/page.tsx`**

1. Add import: `import { OrgSettings } from '@/components/settings/org-settings';`
2. Add import: `import { Building2 } from 'lucide-react';` (already imported via other means — check first; if `Building2` is not imported, add it)
3. Add a new tab trigger after the existing "Team" tab:
   ```
   <TabsTrigger value="organization" className="gap-2">
       <Building2 className="h-4 w-4" />
       Organization
   </TabsTrigger>
   ```
4. Add a new TabsContent after the "team" content:
   ```
   <TabsContent value="organization" className="mt-0">
       <OrgSettings />
   </TabsContent>
   ```
5. Update the header subtitle to: "Manage your organization, workspace settings, and team members"

**Do NOT remove** the existing Team, Workspace, or Notifications tabs — they remain as-is. The Organization tab is additive.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify the full build passes. Grep settings/page.tsx for "organization" to confirm the tab exists. Grep dso-assignment-dialog.tsx for `POST` and `DELETE` to confirm both write operations exist.
  </verify>
  <done>
Settings page has a new "Organization" tab. The OrgSettings component inside it shows org name, member list with org roles, DSO assignments per member, and the DsoAssignmentDialog opens for admins to manage DSO access. Non-admin members see their own DSO assignments. Full build passes.
  </done>
</task>

</tasks>

<verification>
1. Settings page has 4 tabs: Team, Organization, Workspace, Notifications
2. Organization tab shows org name header and member list
3. Each member row shows: name/email, org role badge, DSO assignment badges
4. Admin/owner sees "Edit DSOs" button on each member row
5. Clicking "Edit DSOs" opens a dialog with checkboxes for all org DSOs
6. Checking/unchecking DSOs and clicking "Save Changes" calls POST/DELETE on `/api/orgs/[id]/dso-access`
7. Non-admin member sees their own DSO list but no edit controls
8. `canManage` is derived from `org.role` via `useOrg()` — NOT hardcoded
9. `npm run build` passes (full build verification)
</verification>

<success_criteria>
- UI-01 satisfied: Org settings page shows org name, members with roles, DSO assignments
- UI-02 satisfied: Member can see which DSOs they're assigned to (admin via org settings, non-admin via "Your DSO Access" section)
- UI-03 satisfied: Admin can add/remove DSO assignments from the settings page
- Role-based controls use real org role from OrgContext, not hardcoded
- All three requirements verified by build passing + component structure
</success_criteria>

<output>
After completion, create `.planning/phases/04-org-context-and-settings-ui/04-03-SUMMARY.md`
</output>
