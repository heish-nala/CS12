---
phase: 01-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "organizations, org_members, and user_profiles tables exist in production Supabase with correct columns and indexes"
    - "All 5 existing DSOs (NADG, 7to7, Smile Partners x2, Pure Smiles) have a non-null org_id pointing to Alan's default org"
    - "Alan and Claudia appear in org_members for the default org with correct roles (owner and admin)"
    - "user_dso_access table still exists and all existing routes continue to work (zero downtime)"
    - "Valentina's erroneous user_dso_access rows are removed"
  artifacts: []
  key_links:
    - from: "supabase/migrations/20260226000000_add_org_tables.sql"
      to: "production Supabase (vekxzuupejmitvwwokrf)"
      via: "supabase db push"
      pattern: "supabase db push"
---

<objective>
Push the Phase 1 migration to production Supabase and verify the live database has the correct schema and data.

Purpose: Apply the locally-tested migration to production so the org tables exist for Phase 2 development. Zero downtime required — existing users must not notice anything.
Output: Production database updated with org tables, all existing functionality intact.
</objective>

<execution_context>
@/Users/alan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push migration to production Supabase</name>
  <files></files>
  <action>
Run `supabase db push` from the project root to apply the migration to production Supabase (vekxzuupejmitvwwokrf).

```bash
cd /path/to/cs12-app && supabase db push
```

**Before running:** Confirm local `supabase db reset` passed in Plan 01 (check the 01-01-SUMMARY.md). Do NOT push if local testing failed.

**If push fails:**
- Foreign key violation on auth.users: One of the hardcoded user IDs (Alan, Claudia) doesn't exist in production. All INSERTs use ON CONFLICT DO NOTHING, so this should not happen — but if it does, check that the user IDs match what's in Supabase Dashboard → Authentication → Users.
- Migration already applied: If the timestamp `20260226000000` already exists in `supabase_migrations.schema_migrations`, the push will skip it. This is safe.
- Connection error: Verify Supabase CLI is linked to the correct project (`supabase link` if needed).

After push completes, run verification queries against production:

```bash
# Verify 3 new tables exist in production
# Use the Supabase management API or run queries via the supabase CLI

# Option 1: Via psql if DATABASE_URL is available
# Option 2: Via a quick Node script using supabaseAdmin

# Verify tables exist
npx tsx -e "
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);

async function verify() {
  // Check organizations
  const { data: orgs, error: e1 } = await supabase.from('organizations').select('*');
  console.log('Organizations:', orgs, e1);

  // Check all DSOs have org_id
  const { data: dsos, error: e2 } = await supabase.from('dsos').select('name, org_id');
  console.log('DSOs:', dsos, e2);

  // Check org_members
  const { data: members, error: e3 } = await supabase.from('org_members').select('user_id, role');
  console.log('Org members:', members, e3);

  // Check user_profiles
  const { data: profiles, error: e4 } = await supabase.from('user_profiles').select('*');
  console.log('User profiles:', profiles, e4);

  // Check user_dso_access still works
  const { data: access, error: e5 } = await supabase.from('user_dso_access').select('*');
  console.log('user_dso_access rows:', access?.length, e5);

  // Valentina should have no access
  const { data: val, error: e6 } = await supabase.from('user_dso_access').select('*').eq('user_id', 'd0134916-0f52-4556-9fa0-4c66cff3198e');
  console.log('Valentina access (should be 0):', val?.length, e6);
}
verify();
"
```

Use whatever verification method works with the project's environment (.env.local should have the Supabase URL and service role key).
  </action>
  <verify>
`supabase db push` exits with 0. Verification queries confirm:
1. organizations table has 1 row (All Solutions Consulting)
2. All 5 DSOs have non-null org_id
3. org_members has 2 rows (Alan=owner, Claudia=admin)
4. user_profiles has 2 rows (Alan, Claudia)
5. user_dso_access still has its existing rows (minus Valentina)
6. Valentina has 0 rows in user_dso_access
  </verify>
  <done>Production migration applied, all verification queries pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify production app still works (zero downtime check)</name>
  <files></files>
  <action>
CHECKPOINT: Human verification required.

Phase 1 database migration has been pushed to production:
- 3 new tables created (organizations, org_members, user_profiles)
- org_id added to all 5 DSOs
- Alan (owner) and Claudia (admin) added to default org
- Valentina's erroneous access removed
- user_dso_access table untouched (existing routes should work identically)

Steps for user to verify:
1. Go to https://cs12.allsolutions.consulting
2. Log in as Alan
3. Verify you can see all 5 DSOs in the sidebar/dashboard
4. Click into one DSO (e.g., NADG) and verify the doctor list loads
5. Click into a doctor and verify activities load
6. Go back to dashboard — everything should look exactly the same as before

If anything is broken: The migration only added new tables and a new column — it did NOT change any existing tables, RLS policies, or API routes. If something is broken, it's likely unrelated to this migration. Check browser console for errors.

Resume signal: Type "approved" if the app works normally, or describe any issues you see.
  </action>
  <verify>User confirms the app works normally at cs12.allsolutions.consulting — all DSOs visible, doctors load, activities load.</verify>
  <done>Human has verified the production app works identically to before the migration — zero downtime confirmed.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Production Supabase has organizations, org_members, user_profiles tables
2. All 5 DSOs have org_id pointing to "All Solutions Consulting" org
3. Alan = owner, Claudia = admin in org_members
4. Valentina has no user_dso_access rows
5. The live app at cs12.allsolutions.consulting works identically to before the migration
6. Zero downtime confirmed by human verification
</verification>

<success_criteria>
- `supabase db push` succeeds without errors
- All 5 production DSOs have non-null org_id
- Alan and Claudia in org_members with correct roles
- Valentina access cleaned up
- Live app verified working by human (zero downtime)
- Phase 1 success criteria from ROADMAP.md fully met
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-02-SUMMARY.md`
</output>
